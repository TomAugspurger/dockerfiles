
#include "pyml-env-2.7"

ARG lgCommit=19eececfb889f03640e8c90bb09a00f9bb4a9f2f

RUN apt-get update && \\
    apt-get install -y --no-install-recommends \\
        git \\
        cmake \\
        libboost-dev \\
        libboost-filesystem-dev \\
        libboost-system-dev \\
        make \\
        ocl-icd-libopencl1 \\
        ocl-icd-opencl-dev \\
        tar \\
        unzip \\
        wget && \\
    rm -rf /var/lib/apt/lists && \\
    mkdir /var/lib/apt/lists

// opencl
// TODO: install the correct OpenCL version for the CUDA version
// install the dependencies, except for the driver (nvidia-375),
// as the latter pulls lots of Xserver-related stuff
RUN apt-get update && \\
    apt-get install -y --no-install-recommends \\
        libc6 \\
        ocl-icd-libopencl1 && \\
    rm -rf /var/lib/apt/lists && \\
    mkdir /var/lib/apt/lists

// install the OpenCL ICD without dependencies;
// this actually requires removing dependencies manually
RUN cd /tmp && \\
    apt-get update && \\
    apt-get download nvidia-opencl-icd-375 && \\
    dpkg-deb -R nvidia-opencl-icd-375*.deb nvidia-opencl-icd-375 && \\
    cd nvidia-opencl-icd-375/DEBIAN && \\
    cp control control.bak && \\
    sed -e 's/, nvidia-375[^,]*//' < control.bak > control && \\
    rm -f control.bak && \\
    cd ../.. && \\
    dpkg -b nvidia-opencl-icd-375 nvidia-opencl-icd-375.deb && \\
    dpkg -i nvidia-opencl-icd-375.deb

RUN git config --global http.sslVerify false && \\
    git clone --recursive "https://github.com/Microsoft/LightGBM" && \\
    cd LightGBM && \\
    git reset --hard $lgCommit

ENV LG_COMMIT_ID $lgCommit

RUN cd LightGBM/python-package && \\
    python setup.py install --gpu
